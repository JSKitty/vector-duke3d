<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Duke Nukem 3D</title>
  <link rel="stylesheet" href="js-dos.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      touch-action: none;
    }
    #jsdos {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-family: 'Segoe UI', system-ui, sans-serif;
      z-index: 1000;
    }
    #loading.hidden {
      display: none;
    }
    #loading h1 {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 8px;
      color: #ffd700;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      letter-spacing: 2px;
    }
    #loading .subtitle {
      font-size: 14px;
      color: #888;
      margin-bottom: 30px;
    }
    #status {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #aaa;
      margin-bottom: 40px;
    }
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #333;
      border-top-color: #59fcb3;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .vector-branding {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }
    .vector-branding img {
      width: 20px;
      height: 20px;
    }
    .vector-branding .built-for {
      color: #fff;
    }
    .vector-branding .vector-name {
      color: #59fcb3;
      font-weight: 600;
    }
    /* Hide js-dos UI overlays */
    .emulator-button,
    .emulator-button-control,
    .emulator-keyboard,
    .emulator-options,
    .emulator-control-select,
    .emulator-mouse-overlay,
    #jsdos .z-50,
    #jsdos .absolute.left-0,
    #jsdos [class*="keyboard"] {
      display: none !important;
    }
  </style>
</head>
<body>
  <div id="loading">
    <h1>DUKE NUKEM 3D</h1>
    <div class="subtitle">Episode 1: L.A. Meltdown</div>
    <div id="status"><div class="spinner"></div><span>Loading...</span></div>
    <div class="vector-branding">
      <span class="built-for">Built for</span>
      <img src="vector.png" alt="Vector">
      <span class="vector-name">Vector</span>
    </div>
  </div>
  <div id="jsdos"></div>

  <script src="js-dos.js"></script>
  <script>
    var loadingElement = document.getElementById('loading');
    var statusElement = document.querySelector('#status span');

    async function initDuke3D() {
      try {
        statusElement.textContent = 'Initializing DOSBox...';

        // js-dos v8 API - kiosk mode, no UI
        Dos(document.getElementById("jsdos"), {
          pathPrefix: "./emulators/",
          url: "duke3d.jsdos",
          autoStart: true,
          kiosk: true,
          noCloud: true,
          noNetworking: true,
          onEvent: function(event, ci) {
            if (event === 'ci-ready' && ci) {
              statusElement.textContent = 'Starting game...';
              // Wait for Duke's native resolution (320x200)
              var gameStarted = false;
              ci.events().onFrameSize(function(width, height) {
                if (!gameStarted && width === 320 && height === 200) {
                  gameStarted = true;
                  setTimeout(function() {
                    loadingElement.classList.add('hidden');
                    setupGamepad();
                  }, 500);
                }
              });
            }
          }
        });

        statusElement.textContent = 'Loading Duke Nukem 3D...';

      } catch (err) {
        console.error('Failed to load Duke Nukem 3D:', err);
        statusElement.textContent = 'Error: ' + err.message;
      }
    }

    // Gamepad support
    var gamepadIndex = null;
    var gamepadState = {};

    function setupGamepad() {
      window.addEventListener('gamepadconnected', function(e) {
        console.log('Gamepad connected:', e.gamepad.id);
        gamepadIndex = e.gamepad.index;
        requestAnimationFrame(pollGamepad);
      });

      window.addEventListener('gamepaddisconnected', function(e) {
        console.log('Gamepad disconnected');
        if (e.gamepad.index === gamepadIndex) {
          gamepadIndex = null;
        }
      });

      // Check if gamepad already connected
      var gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
      for (var i = 0; i < gamepads.length; i++) {
        if (gamepads[i]) {
          gamepadIndex = gamepads[i].index;
          requestAnimationFrame(pollGamepad);
          break;
        }
      }
    }

    function isButtonPressed(gp, index) {
      return gp.buttons[index] && gp.buttons[index].pressed;
    }

    // Key codes for js-dos
    var DOS_KEY = {
      ESC: 27,
      '1': 49, '2': 50, '3': 51, '4': 52, '5': 53, '6': 54, '7': 55, '8': 56, '9': 57, '0': 48,
      Q: 81, W: 87, E: 69, R: 82, T: 84,
      A: 65, S: 83, D: 68, F: 70, G: 71, H: 72,
      Z: 90, X: 88, C: 67,
      SPACE: 32, ENTER: 13, TAB: 9,
      CTRL: 17, LSHIFT: 16, RSHIFT: 16, ALT: 18,
      UP: 38, DOWN: 40, LEFT: 37, RIGHT: 39,
      LBRACKET: 219, RBRACKET: 221,
    };

    var gameCanvas = null;

    function sendKey(keyCode, pressed) {
      if (!gameCanvas) {
        gameCanvas = document.querySelector('#jsdos canvas');
      }
      if (gameCanvas) {
        var event = new KeyboardEvent(pressed ? 'keydown' : 'keyup', {
          keyCode: keyCode,
          which: keyCode,
          bubbles: true,
          cancelable: true
        });
        gameCanvas.dispatchEvent(event);
      }
    }

    function pollGamepad() {
      if (gamepadIndex === null) return;

      var gamepads = navigator.getGamepads();
      var gp = gamepads[gamepadIndex];
      if (!gp) {
        requestAnimationFrame(pollGamepad);
        return;
      }

      var deadzone = 0.3;
      var axes = gp.axes;

      // DOOM-style controls
      var mapping = [
        // D-pad: Arrow keys (menus + turning)
        { input: function() { return isButtonPressed(gp, 12); }, keyCode: DOS_KEY.UP },
        { input: function() { return isButtonPressed(gp, 13); }, keyCode: DOS_KEY.DOWN },
        { input: function() { return isButtonPressed(gp, 14); }, keyCode: DOS_KEY.LEFT },
        { input: function() { return isButtonPressed(gp, 15); }, keyCode: DOS_KEY.RIGHT },
        // Left stick: W/S forward/back, A/D strafe
        { input: function() { return axes[1] < -deadzone; }, keyCode: DOS_KEY.W },
        { input: function() { return axes[1] > deadzone; }, keyCode: DOS_KEY.S },
        { input: function() { return axes[0] < -deadzone; }, keyCode: DOS_KEY.A },
        { input: function() { return axes[0] > deadzone; }, keyCode: DOS_KEY.D },
        // Right stick: turn
        { input: function() { return axes[2] < -deadzone; }, keyCode: DOS_KEY.LEFT },
        { input: function() { return axes[2] > deadzone; }, keyCode: DOS_KEY.RIGHT },
        // RT/RB: fire
        { input: function() { return isButtonPressed(gp, 7) || isButtonPressed(gp, 5); }, keyCode: DOS_KEY.Q },
        // A: use/enter
        { input: function() { return isButtonPressed(gp, 0); }, keyCode: DOS_KEY.ENTER },
        // X: jump
        { input: function() { return isButtonPressed(gp, 2); }, keyCode: DOS_KEY.SPACE },
        // B: crouch
        { input: function() { return isButtonPressed(gp, 1); }, keyCode: DOS_KEY.C },
        // Y: map
        { input: function() { return isButtonPressed(gp, 3); }, keyCode: DOS_KEY.TAB },
        // Start: menu
        { input: function() { return isButtonPressed(gp, 9); }, keyCode: DOS_KEY.ESC },
        // Select: enter
        { input: function() { return isButtonPressed(gp, 8); }, keyCode: DOS_KEY.ENTER },
        // LB/LT: weapon prev/next
        { input: function() { return isButtonPressed(gp, 4); }, keyCode: DOS_KEY.LBRACKET },
        { input: function() { return isButtonPressed(gp, 6); }, keyCode: DOS_KEY.RBRACKET },
      ];

      mapping.forEach(function(m, i) {
        var pressed = m.input();
        var wasPressed = gamepadState[i];
        if (pressed !== wasPressed) {
          sendKey(m.keyCode, pressed);
        }
        gamepadState[i] = pressed;
      });

      requestAnimationFrame(pollGamepad);
    }

    // Start when page loads
    window.addEventListener('load', initDuke3D);
  </script>
</body>
</html>
